import pathlib
import fsarcamp as fc
from fsarcamp import campaign_utils


class CROPEX25Campaign:
    def __init__(self, campaign_folder):
        """
        Data loader for SAR data for the CROPEX 2025 campaign.
        The `campaign_folder` path on the DLR-HR server as of November 2024:
        "/hrdss/HR_Data/Pol-InSAR_InfoRetrieval/01_projects/25CROPEX/"
        """
        self.name = "CROPEX 2014"
        self.campaign_folder = pathlib.Path(campaign_folder)
        self.coreg_to_master = campaign_utils.get_coreg_to_master_mapping(self._pass_hierarchy())

    def _pass_hierarchy(self):
        """Nested dictionary: band -> master passes -> coregistered passes"""
        return {
            "X": {
                "25cropex0103": (),
                "25cropex0105": (),
                "25cropex0106": (),
                "25cropex0107": (),
                "25cropex0213": (),
                "25cropex0215": (),
                "25cropex0313": (),
                "25cropex0315": (),
                "25cropex0403": (),
                "25cropex0504": (
                    "25cropex0202",
                    "25cropex0203",
                    "25cropex0204",
                    "25cropex0205",
                    "25cropex0206",
                    "25cropex0207",
                    "25cropex0208",
                    "25cropex0209",
                    "25cropex0210",
                    "25cropex0212",
                    "25cropex0222",
                    "25cropex0223",
                    "25cropex0302",
                    "25cropex0303",
                    "25cropex0304",
                    "25cropex0305",
                    "25cropex0306",
                    "25cropex0307",
                    "25cropex0308",
                    "25cropex0309",
                    "25cropex0310",
                    "25cropex0312",
                    "25cropex0322",
                    "25cropex0323",
                    "25cropex0324",
                    "25cropex0402",
                    "25cropex0404",
                    "25cropex0405",
                    "25cropex0406",
                    "25cropex0407",
                    "25cropex0408",
                    "25cropex0409",
                    "25cropex0502",
                    "25cropex0504",
                    "25cropex0506",
                    "25cropex0507",
                    "25cropex0508",
                    "25cropex0509",
                    "25cropex0510",
                    "25cropex0511",
                    "25cropex0512",
                    "25cropex0521",
                    "25cropex0522",
                    "25cropex0523",
                    "25cropex0524",
                    "25cropex0602",
                    "25cropex0603",
                    "25cropex0605",
                    "25cropex0606",
                    "25cropex0607",
                    "25cropex0608",
                    "25cropex0609",
                    "25cropex0610",
                    "25cropex0611",
                    "25cropex0703",
                    "25cropex0704",
                    "25cropex0706",
                    "25cropex0707",
                    "25cropex0708",
                    "25cropex0709",
                    "25cropex0710",
                    "25cropex0712",
                    "25cropex0722",
                    "25cropex0723",
                    "25cropex0724",
                    "25cropex0725",
                    "25cropex0803",
                    "25cropex0805",
                    "25cropex0806",
                    "25cropex0807",
                    "25cropex0808",
                    "25cropex0809",
                    "25cropex0810",
                    "25cropex0811",
                    "25cropex0812",
                    "25cropex0821",
                    "25cropex0822",
                    "25cropex0823",
                    "25cropex0824",
                    "25cropex0902",
                    "25cropex0903",
                    "25cropex0905",
                    "25cropex0907",
                    "25cropex0908",
                    "25cropex0909",
                    "25cropex0910",
                    "25cropex0911",
                    "25cropex0912",
                    "25cropex0920",
                    "25cropex0921",
                    "25cropex0922",
                    "25cropex0923",
                    "25cropex1002",
                    "25cropex1003",
                    "25cropex1004",
                    "25cropex1005",
                    "25cropex1006",
                    "25cropex1007",
                    "25cropex1008",
                    "25cropex1009",
                    "25cropex1011",
                    "25cropex1021",
                    "25cropex1022",
                    "25cropex1023",
                    "25cropex1024",
                    "25cropex1103",
                    "25cropex1104",
                    "25cropex1105",
                    "25cropex1106",
                    "25cropex1107",
                    "25cropex1108",
                    "25cropex1109",
                    "25cropex1110",
                    "25cropex1111",
                    "25cropex1202",
                    "25cropex1203",
                    "25cropex1204",
                    "25cropex1205",
                    "25cropex1206",
                    "25cropex1207",
                    "25cropex1208",
                    "25cropex1209",
                    "25cropex1211",
                    "25cropex1221",
                    "25cropex1222",
                    "25cropex1223",
                    "25cropex1224",
                    "25cropex1302",
                    "25cropex1303",
                    "25cropex1304",
                    "25cropex1305",
                    "25cropex1306",
                    "25cropex1307",
                    "25cropex1308",
                    "25cropex1309",
                    "25cropex1310",
                    "25cropex1402",
                    "25cropex1403",
                    "25cropex1404",
                    "25cropex1405",
                    "25cropex1406",
                    "25cropex1407",
                    "25cropex1408",
                    "25cropex1409",
                    "25cropex1419",
                    "25cropex1421",
                    "25cropex1422",
                    "25cropex1423",
                    "25cropex1424",
                    "25cropex1502",
                    "25cropex1503",
                    "25cropex1504",
                    "25cropex1505",
                    "25cropex1506",
                    "25cropex1507",
                    "25cropex1508",
                    "25cropex1509",
                    "25cropex1521",
                    "25cropex1522",
                    "25cropex1523",
                    "25cropex1524",
                ),
                "25cropex0505": (),
                "25cropex0514": (),
                "25cropex0604": (),
                "25cropex0713": (),
                "25cropex0714": (),
                "25cropex0802": (),
                "25cropex0814": (),
                "25cropex0906": (),
                "25cropex0914": (),
                "25cropex1010": (),
                "25cropex1013": (),
                "25cropex1025": (),
                "25cropex1102": (),
                "25cropex1210": (),
                "25cropex1214": (),
                "25cropex1225": (),
                "25cropex1311": (),
                "25cropex1411": (),
                "25cropex1420": (),
                "25cropex1425": (),
                "25cropex1510": (),
                "25cropex1511": (),
                "25cropex1514": (),
                "25cropex1525": (),
            },
            "C": {
                "25cropex0107": (),
                "25cropex0213": (),
                "25cropex0313": (),
                "25cropex0403": (),
                "25cropex0504": (
                    "25cropex0103",
                    "25cropex0105",
                    "25cropex0106",
                    "25cropex0108",
                    "25cropex0109",
                    "25cropex0110",
                    "25cropex0111",
                    "25cropex0112",
                    "25cropex0113",
                    "25cropex0123",
                    "25cropex0124",
                    "25cropex0125",
                    "25cropex0127",
                    "25cropex0202",
                    "25cropex0203",
                    "25cropex0204",
                    "25cropex0205",
                    "25cropex0206",
                    "25cropex0207",
                    "25cropex0208",
                    "25cropex0209",
                    "25cropex0210",
                    "25cropex0212",
                    "25cropex0222",
                    "25cropex0223",
                    "25cropex0302",
                    "25cropex0303",
                    "25cropex0304",
                    "25cropex0305",
                    "25cropex0306",
                    "25cropex0307",
                    "25cropex0308",
                    "25cropex0309",
                    "25cropex0310",
                    "25cropex0312",
                    "25cropex0322",
                    "25cropex0323",
                    "25cropex0324",
                    "25cropex0402",
                    "25cropex0404",
                    "25cropex0405",
                    "25cropex0406",
                    "25cropex0407",
                    "25cropex0408",
                    "25cropex0409",
                    "25cropex0502",
                    "25cropex0506",
                    "25cropex0507",
                    "25cropex0508",
                    "25cropex0509",
                    "25cropex0510",
                    "25cropex0511",
                    "25cropex0512",
                    "25cropex0521",
                    "25cropex0522",
                    "25cropex0523",
                    "25cropex0524",
                    "25cropex0602",
                    "25cropex0603",
                    "25cropex0605",
                    "25cropex0606",
                    "25cropex0607",
                    "25cropex0608",
                    "25cropex0609",
                    "25cropex0610",
                    "25cropex0611",
                    "25cropex0703",
                    "25cropex0704",
                    "25cropex0706",
                    "25cropex0707",
                    "25cropex0708",
                    "25cropex0709",
                    "25cropex0710",
                    "25cropex0712",
                    "25cropex0722",
                    "25cropex0723",
                    "25cropex0724",
                    "25cropex0725",
                    "25cropex0803",
                    "25cropex0805",
                    "25cropex0806",
                    "25cropex0807",
                    "25cropex0808",
                    "25cropex0809",
                    "25cropex0810",
                    "25cropex0811",
                    "25cropex0812",
                    "25cropex0821",
                    "25cropex0822",
                    "25cropex0823",
                    "25cropex0824",
                    "25cropex0902",
                    "25cropex0903",
                    "25cropex0905",
                    "25cropex0907",
                    "25cropex0908",
                    "25cropex0909",
                    "25cropex0910",
                    "25cropex0911",
                    "25cropex0912",
                    "25cropex0920",
                    "25cropex0921",
                    "25cropex0922",
                    "25cropex0923",
                    "25cropex1002",
                    "25cropex1003",
                    "25cropex1004",
                    "25cropex1005",
                    "25cropex1006",
                    "25cropex1007",
                    "25cropex1008",
                    "25cropex1009",
                    "25cropex1011",
                    "25cropex1021",
                    "25cropex1022",
                    "25cropex1023",
                    "25cropex1024",
                    "25cropex1103",
                    "25cropex1104",
                    "25cropex1105",
                    "25cropex1106",
                    "25cropex1107",
                    "25cropex1108",
                    "25cropex1109",
                    "25cropex1110",
                    "25cropex1111",
                    "25cropex1202",
                    "25cropex1203",
                    "25cropex1204",
                    "25cropex1205",
                    "25cropex1206",
                    "25cropex1207",
                    "25cropex1208",
                    "25cropex1209",
                    "25cropex1211",
                    "25cropex1221",
                    "25cropex1222",
                    "25cropex1223",
                    "25cropex1224",
                    "25cropex1302",
                    "25cropex1303",
                    "25cropex1304",
                    "25cropex1305",
                    "25cropex1306",
                    "25cropex1307",
                    "25cropex1308",
                    "25cropex1309",
                    "25cropex1310",
                    "25cropex1402",
                    "25cropex1403",
                    "25cropex1404",
                    "25cropex1405",
                    "25cropex1406",
                    "25cropex1407",
                    "25cropex1408",
                    "25cropex1409",
                    "25cropex1419",
                    "25cropex1421",
                    "25cropex1422",
                    "25cropex1423",
                    "25cropex1424",
                    "25cropex1502",
                    "25cropex1503",
                    "25cropex1504",
                    "25cropex1505",
                    "25cropex1506",
                    "25cropex1507",
                    "25cropex1508",
                    "25cropex1509",
                    "25cropex1521",
                    "25cropex1522",
                    "25cropex1523",
                    "25cropex1524",
                ),
                "25cropex0505": (),
                "25cropex0604": (),
                "25cropex0713": (),
                "25cropex0802": (),
                "25cropex0906": (),
                "25cropex1010": (),
                "25cropex1025": (),
                "25cropex1102": (),
                "25cropex1210": (),
                "25cropex1225": (),
                "25cropex1311": (),
                "25cropex1420": (),
                "25cropex1425": (),
                "25cropex1510": (),
                "25cropex1511": (),
                "25cropex1525": (),
            },
            "S": {
                "25cropex0514": (
                    "25cropex0115",
                    "25cropex0117",
                    "25cropex0118",
                    "25cropex0119",
                    "25cropex0120",
                    "25cropex0215",
                    "25cropex0217",
                    "25cropex0218",
                    "25cropex0219",
                    "25cropex0220",
                    "25cropex0315",
                    "25cropex0317",
                    "25cropex0318",
                    "25cropex0319",
                    "25cropex0320",
                    "25cropex0514",
                    "25cropex0516",
                    "25cropex0517",
                    "25cropex0518",
                    "25cropex0519",
                    "25cropex0714",
                    "25cropex0717",
                    "25cropex0718",
                    "25cropex0719",
                    "25cropex0720",
                    "25cropex0814",
                    "25cropex0816",
                    "25cropex0817",
                    "25cropex0818",
                    "25cropex0819",
                    "25cropex0914",
                    "25cropex0916",
                    "25cropex0917",
                    "25cropex0918",
                    "25cropex0919",
                    "25cropex1013",
                    "25cropex1016",
                    "25cropex1017",
                    "25cropex1018",
                    "25cropex1019",
                    "25cropex1214",
                    "25cropex1216",
                    "25cropex1217",
                    "25cropex1218",
                    "25cropex1219",
                    "25cropex1411",
                    "25cropex1413",
                    "25cropex1414",
                    "25cropex1415",
                    "25cropex1416",
                    "25cropex1514",
                    "25cropex1516",
                    "25cropex1517",
                    "25cropex1518",
                    "25cropex1519",
                )
            },
            "L": {
                "25cropex0107": (),
                "25cropex0213": (),
                "25cropex0313": (),
                "25cropex0403": (),
                "25cropex0504": (
                    "25cropex0103",
                    "25cropex0105",
                    "25cropex0106",
                    "25cropex0108",
                    "25cropex0109",
                    "25cropex0110",
                    "25cropex0111",
                    "25cropex0112",
                    "25cropex0113",
                    "25cropex0115",
                    "25cropex0117",
                    "25cropex0118",
                    "25cropex0119",
                    "25cropex0120",
                    "25cropex0123",
                    "25cropex0124",
                    "25cropex0125",
                    "25cropex0127",
                    "25cropex0202",
                    "25cropex0203",
                    "25cropex0204",
                    "25cropex0205",
                    "25cropex0206",
                    "25cropex0207",
                    "25cropex0208",
                    "25cropex0209",
                    "25cropex0210",
                    "25cropex0212",
                    "25cropex0215",
                    "25cropex0217",
                    "25cropex0218",
                    "25cropex0219",
                    "25cropex0220",
                    "25cropex0222",
                    "25cropex0223",
                    "25cropex0302",
                    "25cropex0303",
                    "25cropex0304",
                    "25cropex0305",
                    "25cropex0306",
                    "25cropex0307",
                    "25cropex0308",
                    "25cropex0309",
                    "25cropex0310",
                    "25cropex0312",
                    "25cropex0315",
                    "25cropex0317",
                    "25cropex0318",
                    "25cropex0319",
                    "25cropex0320",
                    "25cropex0322",
                    "25cropex0323",
                    "25cropex0324",
                    "25cropex0402",
                    "25cropex0404",
                    "25cropex0405",
                    "25cropex0406",
                    "25cropex0407",
                    "25cropex0408",
                    "25cropex0409",
                    "25cropex0502",
                    "25cropex0506",
                    "25cropex0507",
                    "25cropex0508",
                    "25cropex0509",
                    "25cropex0510",
                    "25cropex0511",
                    "25cropex0512",
                    "25cropex0514",
                    "25cropex0516",
                    "25cropex0517",
                    "25cropex0518",
                    "25cropex0519",
                    "25cropex0521",
                    "25cropex0522",
                    "25cropex0523",
                    "25cropex0524",
                    "25cropex0602",
                    "25cropex0603",
                    "25cropex0605",
                    "25cropex0606",
                    "25cropex0607",
                    "25cropex0608",
                    "25cropex0609",
                    "25cropex0610",
                    "25cropex0611",
                    "25cropex0703",
                    "25cropex0704",
                    "25cropex0705",
                    "25cropex0706",
                    "25cropex0707",
                    "25cropex0708",
                    "25cropex0709",
                    "25cropex0710",
                    "25cropex0712",
                    "25cropex0714",
                    "25cropex0717",
                    "25cropex0718",
                    "25cropex0719",
                    "25cropex0720",
                    "25cropex0722",
                    "25cropex0723",
                    "25cropex0724",
                    "25cropex0725",
                    "25cropex0803",
                    "25cropex0805",
                    "25cropex0806",
                    "25cropex0807",
                    "25cropex0808",
                    "25cropex0809",
                    "25cropex0810",
                    "25cropex0811",
                    "25cropex0812",
                    "25cropex0814",
                    "25cropex0816",
                    "25cropex0817",
                    "25cropex0818",
                    "25cropex0819",
                    "25cropex0821",
                    "25cropex0822",
                    "25cropex0823",
                    "25cropex0824",
                    "25cropex0902",
                    "25cropex0903",
                    "25cropex0905",
                    "25cropex0907",
                    "25cropex0908",
                    "25cropex0909",
                    "25cropex0910",
                    "25cropex0911",
                    "25cropex0912",
                    "25cropex0914",
                    "25cropex0916",
                    "25cropex0917",
                    "25cropex0918",
                    "25cropex0919",
                    "25cropex0920",
                    "25cropex0921",
                    "25cropex0922",
                    "25cropex0923",
                    "25cropex1002",
                    "25cropex1003",
                    "25cropex1004",
                    "25cropex1005",
                    "25cropex1006",
                    "25cropex1007",
                    "25cropex1008",
                    "25cropex1009",
                    "25cropex1011",
                    "25cropex1013",
                    "25cropex1016",
                    "25cropex1017",
                    "25cropex1018",
                    "25cropex1019",
                    "25cropex1021",
                    "25cropex1022",
                    "25cropex1023",
                    "25cropex1024",
                    "25cropex1103",
                    "25cropex1104",
                    "25cropex1105",
                    "25cropex1106",
                    "25cropex1107",
                    "25cropex1108",
                    "25cropex1109",
                    "25cropex1110",
                    "25cropex1111",
                    "25cropex1202",
                    "25cropex1203",
                    "25cropex1204",
                    "25cropex1205",
                    "25cropex1206",
                    "25cropex1207",
                    "25cropex1208",
                    "25cropex1209",
                    "25cropex1211",
                    "25cropex1214",
                    "25cropex1216",
                    "25cropex1217",
                    "25cropex1218",
                    "25cropex1219",
                    "25cropex1221",
                    "25cropex1222",
                    "25cropex1223",
                    "25cropex1224",
                    "25cropex1302",
                    "25cropex1303",
                    "25cropex1304",
                    "25cropex1305",
                    "25cropex1306",
                    "25cropex1307",
                    "25cropex1308",
                    "25cropex1309",
                    "25cropex1310",
                    "25cropex1402",
                    "25cropex1403",
                    "25cropex1404",
                    "25cropex1405",
                    "25cropex1406",
                    "25cropex1407",
                    "25cropex1408",
                    "25cropex1409",
                    "25cropex1411",
                    "25cropex1413",
                    "25cropex1414",
                    "25cropex1415",
                    "25cropex1416",
                    "25cropex1419",
                    "25cropex1421",
                    "25cropex1422",
                    "25cropex1423",
                    "25cropex1424",
                    "25cropex1502",
                    "25cropex1503",
                    "25cropex1504",
                    "25cropex1505",
                    "25cropex1506",
                    "25cropex1507",
                    "25cropex1508",
                    "25cropex1509",
                    "25cropex1514",
                    "25cropex1516",
                    "25cropex1517",
                    "25cropex1518",
                    "25cropex1519",
                    "25cropex1521",
                    "25cropex1522",
                    "25cropex1523",
                    "25cropex1524",
                ),
                "25cropex0505": (),
                "25cropex0604": (),
                "25cropex0713": (),
                "25cropex0802": (),
                "25cropex0906": (),
                "25cropex1010": (),
                "25cropex1025": (),
                "25cropex1102": (),
                "25cropex1210": (),
                "25cropex1225": (),
                "25cropex1311": (),
                "25cropex1420": (),
                "25cropex1425": (),
                "25cropex1510": (),
                "25cropex1511": (),
                "25cropex1525": (),
            },
        }


class CROPEX25Pass:
    def __init__(self, campaign_folder, pass_name, band, master_name=None):
        self.campaign_folder = pathlib.Path(campaign_folder)
        self.pass_name = pass_name
        self.band = band
        self.master_name = master_name

    # RGI folder

    def load_rgi_slc(self, pol, antenna=""):
        """
        Load SLC in specified polarization ("hh", "hv", "vh", "vv") from the RGI folder.
        Multiple antennas are available for selected passes, the antenna ID can be specified with `antenna`.
        """
        return fc.mrrat(
            self._rgi_folder() / "RGI-SR" / f"slc_{self.pass_name}_{self.band}{antenna}{pol}_t01{self.band}.rat"
        )

    def load_rgi_incidence(self, pol=None):
        """
        Load incidence angle from the RGI folder.
        Polarization is ignored for the CROPEX 25 campaign.
        """
        return fc.mrrat(self._rgi_folder() / "RGI-SR" / f"incidence_{self.pass_name}_{self.band}_t01{self.band}.rat")

    def load_rgi_params(self, pol="hh"):
        """
        Load radar parameters from the RGI folder. Default polarization is "hh".
        """
        return campaign_utils.parse_xml_parameters(
            self._rgi_folder() / "RGI-RDP" / f"pp_{self.pass_name}_{self.band}{pol}_t01{self.band}.xml"
        )

    # INF folder

    def load_inf_slc(self, pol, antenna=""):
        """
        Load coregistered SLC in specified polarization ("hh", "hv", "vh", "vv") from the INF folder.
        Multiple antennas are available for selected passes, the antenna ID combination can be specified with `antenna`.
        """
        return fc.mrrat(
            self._inf_folder()
            / "INF-SR"
            / f"slc_coreg_{self.master_name}_{self.pass_name}_{self.band}{antenna}{pol}_t01{self.band}.rat"
        )

    def load_inf_pha_dem(self, pol=None):
        """
        Load interferometric phase correction derived from track and terrain geometry.
        The residual can be used to correct the phase of the coregistered SLCs: coreg_slc * np.exp(1j * phase)
        This is equivalent of subtracting the phase from the interferogram.
        Polarization is ignored for the CROPEX 25 campaign.
        """
        return fc.mrrat(
            self._inf_folder()
            / "INF-SR"
            / f"pha_dem_{self.master_name}_{self.pass_name}_{self.band}_t01{self.band}.rat"
        )

    def load_inf_pha_fe(self, pol=None):
        """
        Load interferometric flat-Earth phase.
        For the CROPEX 25 campaign, this phase is included into pha_dem and pha_fe is 0.
        Polarization is ignored for the CROPEX 25 campaign.
        """
        return fc.mrrat(
            self._inf_folder() / "INF-SR" / f"pha_fe_{self.master_name}_{self.pass_name}_{self.band}_t01{self.band}.rat"
        )

    def load_inf_kz(self, pol, antenna=""):
        """
        Load interferometric kz.
        Multiple antennas are available for selected passes, the antenna ID combination can be specified with `antenna`.
        """
        return fc.mrrat(
            self._inf_folder()
            / "INF-SR"
            / f"kz_{self.master_name}_{self.pass_name}_{self.band}{antenna}{pol}_t01{self.band}.rat"
        )

    def load_inf_params(self, pol="hh"):
        """
        Load radar parameters from the INF folder. Default polarization is "hh".
        """
        return campaign_utils.parse_xml_parameters(
            self._inf_folder() / "INF-RDP" / f"pp_{self.pass_name}_{self.band}{pol}_t01{self.band}.xml"
        )

    def load_inf_insar_params(self, pol="hh"):
        """
        Load insar radar parameters from the INF folder. Default polarization is "hh".
        """
        return campaign_utils.parse_xml_parameters(
            self._inf_folder()
            / "INF-RDP"
            / f"ppinsar_{self.master_name}_{self.pass_name}_{self.band}{pol}_t01{self.band}.xml"
        )

    # GTC folder

    def load_gtc_sr2geo_lut(self):
        """TODO"""

    # Helpers

    def _rgi_folder(self):
        flight_id, pass_id = campaign_utils.get_flight_and_pass_ids(self.pass_name)
        return self.campaign_folder / f"FL{flight_id}/PS{pass_id}/T01{self.band}/RGI"

    def _inf_folder(self):
        flight_id, pass_id = campaign_utils.get_flight_and_pass_ids(self.pass_name)
        pass_folder = self.campaign_folder / f"FL{flight_id}/PS{pass_id}/T01{self.band}"
        triple_flights = {
            "04": "04-05-06",
            "05": "04-05-06",
            "06": "04-05-06",
            "11": "11-12-13",
            "12": "11-12-13",
            "13": "11-12-13",
            # planned triple flights
            "21": "21-22-23",
            "22": "21-22-23",
            "23": "21-22-23",
        }
        if flight_id in triple_flights:
            return pass_folder / f"INF_{triple_flights[flight_id]}"
        else:
            return pass_folder / f"INF_{flight_id}"

    def __repr__(self):
        return f"{self.pass_name}_{self.band}"
